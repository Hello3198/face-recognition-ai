<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
<script>
    const PROXY = "https://proxy.cors.sh/";
    const URL = PROXY + "https://teachablemachine.withgoogle.com/models/rPgActXOw/";

    let model, webcam, maxPredictions, sessionKnown = {};
    const statusEl = document.getElementById("status");
    const btnArea = document.getElementById("buttonArea");
    const btnKnown = document.getElementById("btnKnown");
    const btnUnknown = document.getElementById("btnUnknown");
    const beep = document.getElementById("beep");

    async function init() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      try {
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        webcam = new tmImage.Webcam(360, 270, true);
        await webcam.setup({ facingMode: "user" });
        await webcam.play();
        window.requestAnimationFrame(loop);

        document.getElementById("webcam").srcObject = webcam.webcam;
        statusEl.innerText = "Model loaded. Ready!";
      } catch (error) {
        console.error("Model load failed:", error);
        statusEl.innerText = "❌ Failed to load model: " + error.message;
      }
    }

    async function loop() {
      webcam.update();
      await predict();
      window.requestAnimationFrame(loop);
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);
      prediction.sort((a, b) => b.probability - a.probability);
      const top = prediction[0];
      const cls = top.className;
      const conf = top.probability;

      if (conf < 0.2) {
        updateState("Safe", false);
      } else if (sessionKnown[cls]) {
        updateState(`Verified (${cls})`, false);
      } else if (cls !== "Stranger") {
        updateState(`Verified (${cls})`, false);
      } else {
        updateState("Suspicious Activity Detected", true);
      }
    }

    function updateState(msg, suspect) {
      statusEl.textContent = msg;
      if (suspect) {
        document.body.style.backgroundColor = "rgba(255,0,0,0.2)";
        beep.play();
        btnArea.style.display = "block";
      } else {
        document.body.style.backgroundColor = "";
        beep.pause(); beep.currentTime = 0;
        btnArea.style.display = "none";
      }
    }

    btnKnown.onclick = () => {
      const name = prompt("Name of the person?");
      if (name) {
        sessionKnown["Stranger"] = name;
        updateState(`Verified (${name})`, false);
      }
    };

    btnUnknown.onclick = () => {
      alert("Unknown person not added. Will alert next time.");
      btnArea.style.display = "none";
    };

    init();
</script>

